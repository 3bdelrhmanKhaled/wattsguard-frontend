<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© - WattsGuard</title>
    <link rel="icon" type="image/png" href="images/Rectangle-1.png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icons">
                <a href="#" class="notification"><i class="far fa-bell"></i></a>
            </div>
            <h2 class="text-s">Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø²</h2>
            <a href="season.html" class="back text-decoration-none"><i class="fa-solid fa-arrow-right"></i></a>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
            <div class="progress-steps" id="progressBar"></div>
        </div>
        <div class="step-counter" id="stepCounter"></div>
        <div id="step-container"></div>

        <div class="text-center">
            <button id="yourDevicesButton" class="btn btn-primary" style="display:none">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</button>
            <button id="detailedConsumptionButton" class="btn btn-primary" style="display:none">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</button>
            <div class="loading-spinner" id="loadingSpinner"></div>
        </div>

        <div id="result-section" style="display:none; margin-top: 20px;">
            <div class="result-card">
                <h4 class="text-right">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h4>
                <table class="table table-bordered text-right">
                    <thead><tr><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</th><th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th></tr></thead>
                    <tbody id="rawPowerTable"></tbody>
                </table>
            </div>
            <div class="result-card">
                <h4 class="text-right">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²</h4>
                <table class="table table-bordered text-right">
                    <thead><tr><th>Ø§Ù„ÙØ¦Ø©</th><th>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„</th><th>Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ùƒ.Ùˆ.Ø³)</th><th>Ø¹Ø¯Ø¯ Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠÙ‹Ø§</th></tr></thead>
                    <tbody id="summaryTable"></tbody>
                </table>
                <p id="billRange" class="mt-4 text-right font-weight-bold"></p>
                <p id="message" class="text-danger text-right"></p>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/electricity.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                const messageElement = document.getElementById('message');
                messageElement.innerText = 'ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹';
                setTimeout(() => {
                    window.location.href = 'Login.html';
                }, 5000);
                return;
            }
        });

        const devices = [
            { name: "Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©", models: [] },
            { name: "Ø«Ù„Ø§Ø¬Ø©", models: ["FNT-B400 BB"] },
            { name: "ØºØ³Ø§Ù„Ø©", models: ["EL1087567SLV", "EL1094877SLV"] },
            { name: "Ù…ÙƒÙŠÙ", models: ["S4-H24TZAAE"] },
            { name: "ØºÙ„Ø§ÙŠØ© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©", models: ["EL1113367BLK"] },
            { name: "Ø³Ø®Ø§Ù† Ù…ÙŠØ§Ù‡", models: ["TEEE-30MW"] },
            { name: "Ù‚Ù„Ø§ÙŠØ©", models: ["TDF-3700"] },
            { name: "Ù…ÙƒÙ†Ø³Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©", models: ["TVC-1200B"] },
            { name: "ØºØ³Ø§Ù„Ø© Ø£Ø·Ø¨Ø§Ù‚", models: ["EL1108866SLV"] },
            { name: "Ø¨ÙˆØªØ§Ø¬Ø§Ø²", models: ["HP41125B"] },
            { name: "Ù…ÙƒÙˆØ§Ø© Ø¨Ø®Ø§Ø±", models: ["GS42622A"] },
            { name: "ÙØ±Ù†", models: ["ak-45"] },
            { name: "Ù…ÙŠÙƒØ±ÙˆÙˆÙŠÙ", models: ["MOM-C25BBE-BK"] },
            { name: "Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ", models: [] },
            { name: "Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ", models: [] }
        ];

        let currentStep = 0;
        let answers = [];
        let structuredAnswers = [];
        let budget = null;
        let apiData = null;

        const urlParams = new URLSearchParams(window.location.search);
        const season = urlParams.get('season') || 'summer';

        function renderProgressBar() {
            const totalSteps = 1 + (devices.length - 3) * 3;
            const visibleSteps = 15;
            const stepNumbers = Array.from({ length: visibleSteps }, (_, i) => i + 1);
            let visibleStep = 0;
            if (currentStep === 0) {
                visibleStep = 0;
            } else if (currentStep <= 36) {
                const deviceIndex = Math.min(Math.floor((currentStep - 1) / 3), devices.length - 3);
                visibleStep = deviceIndex + 1;
            } else if (currentStep === 37) {
                visibleStep = 13;
            } else {
                visibleStep = 14;
            }
            const progressPercentage = ((visibleStep + 1) / visibleSteps) * 100;
            document.getElementById("progressBarFill").style.width = `${progressPercentage}%`;
            document.getElementById("progressBar").innerHTML = stepNumbers.map((n, i) => `
                <div class="step-item">
                    <span class="${i === visibleStep ? 'active' : ''}">${n}</span>
                </div>
            `).join('');
            document.getElementById("stepCounter").innerText = `Ø§Ù„Ø®Ø·ÙˆØ© ${visibleStep + 1} Ù…Ù† ${visibleSteps}`;
        }

        async function sendToBackend(budget, structuredAnswers) {
            const loadingSpinner = document.getElementById("loadingSpinner");
            const messageElement = document.getElementById("message");
            
            loadingSpinner.classList.add("active");
            messageElement.innerText = '';

            const payload = [budget, ...structuredAnswers.flat()];
            console.log("ğŸ“¤ Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±... Payload:", payload);

            try {
                const data = await window.electricity.calculate(payload, season);
                console.log('âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:', data);

                // Format power values to include unit
                const formattedData = {
                    raw_power_data: data.rawPowerData?.map(row => ({
                        ...row,
                        "Electric Power": `${parseFloat(row["Electric Power"] || 0).toFixed(2)} ÙˆØ§Ø·`
                    })) || [],
                    summary: data.summary?.map(row => ({
                        ...row,
                        "Monthly Consumption (kWh)": `${parseFloat(row["Monthly Consumption (kWh)"] || 0).toFixed(2)} Ùƒ.Ùˆ.Ø³`
                    })) || [],
                    estimated_bill_range: data.estimatedBillRange || '',
                    message: data.message || ''
                };

                apiData = formattedData;
                console.log("ğŸ“¦ Ù…Ø­ØªÙˆÙ‰ apiData Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:", apiData);

                // Update the tables immediately
                updateTables();
            } catch (error) {
                console.error('ğŸš¨ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±:', error);
                apiData = {
                    raw_power_data: [],
                    summary: [],
                    estimated_bill_range: "",
                    message: "ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±"
                };
                messageElement.innerText = `Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ø§Ø­Ù‚Ù‹Ø§.`;
            } finally {
                loadingSpinner.classList.remove("active");
            }
        }

        document.getElementById("yourDevicesButton").addEventListener("click", () => {
            if (!apiData) {
                document.getElementById("message").innerText = "ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª";
                return;
            }

            const resultSection = document.getElementById("result-section");
            resultSection.style.display = "block";

            const rawPowerTable = document.getElementById("rawPowerTable");
            if (!rawPowerTable) {
                console.error("Ø§Ù„Ø¹Ù†ØµØ± rawPowerTable ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM");
                return;
            }

            if (apiData.raw_power_data && apiData.raw_power_data.length > 0) {
                rawPowerTable.innerHTML = apiData.raw_power_data.map(row =>
                    `<tr><td>${row.Category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td><td>${row["Electric Power"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td><td>${row["Model Name"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td></tr>`
                ).join('');
            } else {
                rawPowerTable.innerHTML = `<tr><td colspan="3" class="no-data-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶</td></tr>`;
            }

            document.getElementById("yourDevicesButton").style.display = "none";
            currentStep++;
            renderStep();
        });

        function updateTables() {
            const resultSection = document.getElementById("result-section");
            resultSection.style.display = "block";

            // Update raw power table
            const rawPowerTable = document.getElementById("rawPowerTable");
            if (apiData.raw_power_data && apiData.raw_power_data.length > 0) {
                rawPowerTable.innerHTML = apiData.raw_power_data.map(row =>
                    `<tr>
                        <td>${row.Category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${row["Electric Power"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>${row["Model Name"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                    </tr>`
                ).join('');
            } else {
                rawPowerTable.innerHTML = `<tr><td colspan="3" class="no-data-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶</td></tr>`;
            }

            // Update summary table
            const summaryTable = document.getElementById("summaryTable");
            if (apiData.summary && apiData.summary.length > 0) {
                summaryTable.innerHTML = apiData.summary.map(row =>
                    `<tr>
                        <td>${row.Category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${row["Model Name"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>${row["Monthly Consumption (kWh)"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>${row["Daily Hours"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                    </tr>`
                ).join('');
            } else {
                summaryTable.innerHTML = `<tr><td colspan="4" class="no-data-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø±Ø¶</td></tr>`;
            }

            // Update bill range and message
            document.getElementById("billRange").innerText = apiData.estimated_bill_range ? `Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø©: ${apiData.estimated_bill_range} Ø¬Ù†ÙŠÙ‡` : '';
            document.getElementById("message").innerText = apiData.message || '';
        }

        function renderStep() {
            const container = document.getElementById("step-container");
            container.innerHTML = "";
            document.getElementById("yourDevicesButton").style.display = "none";
            document.getElementById("detailedConsumptionButton").style.display = "none";
            renderProgressBar();

            const card = document.createElement("div");
            card.classList.add("question-card");

            if (currentStep === 0) {
                card.innerHTML = `
                    <label for="budget">Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©ØŸ</label>
                    <p class="text-muted">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø°ÙŠ ØªØ±ØºØ¨ ÙÙŠ Ø¥Ù†ÙØ§Ù‚Ù‡</p>
                    <input type="number" id="budget" class="form-control" min="100" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ø¬Ù†ÙŠÙ‡)">
                    <button class="btn btn-primary mt-3" onclick="saveBudget()">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
            } else if (currentStep < 1 + (devices.length - 3) * 3) {
                const deviceIndex = Math.min(Math.floor((currentStep - 1) / 3), devices.length - 3);
                const device = devices[deviceIndex + 1];
                if ((currentStep - 1) % 3 === 0) {
                    card.innerHTML = `
                        <h3>Ù‡Ù„ Ù„Ø¯ÙŠÙƒ ${device.name}ØŸ</h3>
                        <p class="text-muted">Ø­Ø¯Ø¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø¯ÙŠÙƒ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</p>
                        <button class="btn btn-primary" onclick="handleYes()">Ù†Ø¹Ù…</button>
                        <button class="btn btn-primary" onclick="handleNo()">Ù„Ø§</button>`;
                } else if ((currentStep - 1) % 3 === 1) {
                    card.innerHTML = `
                        <label for="deviceCount">ÙƒÙ… Ø¹Ø¯Ø¯ ${device.name} Ù„Ø¯ÙŠÙƒØŸ</label>
                        <p class="text-muted">Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©</p>
                        <input type="number" id="deviceCount" class="form-control" min="1" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ø¯Ø¯">
                        <button class="btn btn-primary mt-3" onclick="nextStep()">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
                } else {
                    const count = answers[answers.length - 1];
                    card.innerHTML = `
                        <h4>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„Ø§Øª (${device.name})</h4>
                        <p class="text-muted">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ Ø£Ùˆ Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª</p>
                        ${Array.from({ length: count }, (_, i) => `
                            <div class="model-details-container">
                                <div style="flex: 1;">
                                    <input type="text" id="model_${i}" list="model_list_${i}" class="form-control my-2 model-input" placeholder="Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„">
                                    <datalist id="model_list_${i}">
                                        ${device.models.map(model => `<option value="${model}">${model}</option>`).join('')}
                                    </datalist>
                                </div>
                                <div class="model-details" id="modelDetails_${i}" style="display: none; flex: 1;"></div>
                            </div>
                            <div class="image-upload">
                                <label for="model_image_${i}">Ø¥Ø°Ø§ ÙƒÙ†Øª Ù„Ø§ ØªØ¹Ù„Ù… Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„ÙŠÙ‡</label>
                                <input type="file" id="model_image_${i}" accept="image/*" title="Ø§Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²">
                            </div>`).join('')}
                        <button class="btn btn-primary mt-3" onclick="submitModels(${count})">Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
                }
            } else if (currentStep >= 37) {
                document.getElementById("yourDevicesButton").style.display = "inline-block";
                document.getElementById("detailedConsumptionButton").style.display = "inline-block";
                card.innerHTML = `<p class="text-center">ØªÙ… Ø¬Ù…Ø¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.</p>`;
            }
            container.appendChild(card);

            if ((currentStep - 1) % 3 === 2 && currentStep < 37) {
                const count = answers[answers.length - 1];
                setTimeout(() => {
                    for (let i = 0; i < count; i++) {
                        const modelInput = document.getElementById(`model_${i}`);
                        const modelDetails = document.getElementById(`modelDetails_${i}`);
                        if (modelInput && modelDetails) {
                            modelInput.addEventListener('change', () => {
                                const modelName = modelInput.value.trim();
                                if (modelName) {
                                    getModelDetails(modelName, modelDetails);
                                } else {
                                    modelDetails.style.display = 'none';
                                }
                            });
                        }
                    }
                }, 0);
            }
        }

        async function getModelDetails(modelName, detailsElement) {
            const messageElement = document.getElementById("message");
            messageElement.innerText = "";
            detailsElement.innerHTML = '<div class="loading-spinner active"></div>';

            try {
                const data = await window.electricity.getModelDetails(encodeURIComponent(modelName));
                console.log('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©:', data);

                if (data.success && data.modelDetails) {
                    const detailsStr = data.modelDetails;
                    // Split the details string into lines and create an object
                    const details = {};
                    detailsStr.split('\n').forEach(line => {
                        if (line.includes(':')) {
                            const [key, value] = line.split(':').map(s => s.trim());
                            details[key] = value;
                        }
                    });
                    
                    // Clean up and convert power value
                    let power = details["Electric Power"];
                    if (power) {
                        // Remove any whitespace and normalize decimal separator
                        power = power.replace(/\s+/g, '').replace(',', '.');
                        
                        // Check if it's in kW format
                        if (power.includes('kW')) {
                            power = parseFloat(power) * 1000 + ' ÙˆØ§Ø·';
                        } else if (power.includes('W')) {
                            // Remove the 'W' and keep the number
                            power = parseFloat(power) + ' ÙˆØ§Ø·';
                        } else {
                            // If no unit is specified, assume kW
                            power = parseFloat(power) * 1000 + ' ÙˆØ§Ø·';
                        }
                        
                        // Round to 2 decimal places if needed
                        const powerNum = parseFloat(power);
                        if (!isNaN(powerNum)) {
                            power = powerNum.toFixed(2) + ' ÙˆØ§Ø·';
                        }
                    }

                    detailsElement.innerHTML = `
                        <strong>Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:</strong> ${details["Model Name"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}<br>
                        <strong>Ø§Ù„Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©:</strong> ${details.Brand || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}<br>
                        <strong>Ø§Ù„ÙØ¦Ø©:</strong> ${details["catogory"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}<br>
                        <strong>Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©:</strong> ${power || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}<br>
                        ${details.Capacity ? `<strong>Ø§Ù„Ø³Ø¹Ø©:</strong> ${details.Capacity} Ù„ØªØ±` : ''}
                    `;
                    detailsElement.style.display = 'block';
                } else {
                    const errorMessage = data.error || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙØ§ØµÙŠÙ„ Ù…ØªÙˆÙØ±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„';
                    detailsElement.innerHTML = `
                        <div class="error-message">
                            <strong>Ø®Ø·Ø£:</strong> ${errorMessage}<br>
                            <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ØŒ Ù„ÙƒÙ† Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø©.</small>
                        </div>
                    `;
                    detailsElement.style.display = 'block';
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„:', error);
                detailsElement.innerHTML = `
                    <div class="error-message">
                        <strong>Ø®Ø·Ø£:</strong> ${error.message}<br>
                        <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ØŒ Ù„ÙƒÙ† Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ø·Ø§Ù‚Ø©.</small>
                    </div>
                `;
                detailsElement.style.display = 'block';
                messageElement.innerText = `Ø®Ø·Ø£: ${error.message}`;
            }
        }

        function saveBudget() {
            const input = document.getElementById("budget").value;
            if (!input || input < 100) {
                document.getElementById("message").innerText = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙŠØ²Ø§Ù†ÙŠØ© ØµØ§Ù„Ø­Ø© (100 Ø¬Ù†ÙŠÙ‡ Ø£Ùˆ Ø£ÙƒØ«Ø±)";
                return;
            }
            budget = input.toString();
            currentStep++;
            renderStep();
        }

        function handleYes() {
            answers.push("yes");
            structuredAnswers.push(["yes"]);
            currentStep++;
            renderStep();
        }

        function handleNo() {
            answers.push("no");
            structuredAnswers.push(["no", "0"]);
            currentStep = Math.min(currentStep + 3, 1 + (devices.length - 3) * 3);
            renderStep();
        }

        function nextStep() {
            const count = parseInt(document.getElementById("deviceCount").value);
            if (!count || count < 1) {
                document.getElementById("message").innerText = "ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­";
                return;
            }
            answers.push(count.toString());
            structuredAnswers[structuredAnswers.length - 1].push(count.toString());
            currentStep++;
            renderStep();
        }

        async function submitModels(count) {
            const messageElement = document.getElementById("message");
            messageElement.innerText = "";

            for (let i = 0; i < count; i++) {
                const model = document.getElementById(`model_${i}`).value.trim();
                if (!model) {
                    messageElement.innerText = `ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ¯ÙŠÙ„ Ù„Ù„Ø¬Ù‡Ø§Ø² Ø±Ù‚Ù… ${i + 1}`;
                    return;
                }
                answers.push(model);
                structuredAnswers[structuredAnswers.length - 1].push(model);

                const imageInput = document.getElementById(`model_image_${i}`);
                if (imageInput.files.length > 0) {
                    try {
                        const formData = new FormData();
                        formData.append('image', imageInput.files[0]);
                        await window.api.post('/Electricity/upload-image', formData);
                        console.log(`ØªÙ… Ø±ÙØ¹ ØµÙˆØ±Ø© Ù„Ù„Ø¬Ù‡Ø§Ø² ${i + 1}:`, imageInput.files[0].name);
                    } catch (error) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:', error);
                        messageElement.innerText = `Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¬Ù‡Ø§Ø² ${i + 1}: ${error.message}`;
                        return;
                    }
                }
            }
            currentStep++;
            if (currentStep === 37) {
                await sendToBackend(budget, structuredAnswers);
            }
            renderStep();
        }

        document.getElementById("detailedConsumptionButton").addEventListener("click", () => {
            if (!apiData) {
                document.getElementById("message").innerText = "ÙŠØ±Ø¬Ù‰ Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø£ÙˆÙ„Ø§Ù‹";
                return;
            }

            const summaryTable = document.getElementById("summaryTable");
            if (!summaryTable) {
                console.error("Ø§Ù„Ø¹Ù†ØµØ± summaryTable ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù€ DOM");
                return;
            }

            if (apiData.summary && apiData.summary.length > 0) {
                summaryTable.innerHTML = apiData.summary.map(row => `
                    <tr>
                        <td>${row.Category || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
                        <td>${row["Model name"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>${row["Monthly Consumption (kWh)"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                        <td>${row["Daily Hours"] || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
                    </tr>
                `).join('');
                document.getElementById("billRange").innerText = apiData.estimated_bill_range ? `Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø©: ${apiData.estimated_bill_range} Ø¬Ù†ÙŠÙ‡` : '';
                document.getElementById("message").innerText = apiData.message || '';
            } else {
                summaryTable.innerHTML = `<tr><td colspan="4" class="no-data-message">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</td></tr>`;
                document.getElementById("billRange").innerText = apiData.estimated_bill_range ? `Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„ÙØ§ØªÙˆØ±Ø©: ${apiData.estimated_bill_range} Ø¬Ù†ÙŠÙ‡` : '';
                document.getElementById("message").innerText = apiData.message || '';
            }
            document.getElementById("detailedConsumptionButton").style.display = "none";
        });

        document.addEventListener('DOMContentLoaded', function() {
            renderStep();
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'Login.html';
        }
    </script>
</body>
</html>