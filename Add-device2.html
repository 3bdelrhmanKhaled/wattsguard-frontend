<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>خطوات الأجهزة - WattsGuard</title>
    <link rel="icon" type="image/png" href="images/Rectangle-1.png">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Cairo', sans-serif;
            min-height: 100vh;
            padding-top: 20px;
            margin: 0;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: #fff;
            border-bottom: solid 2px #4E5F53;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
        }
        .icons a {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #4E5F53;
            border: solid 1px #4E5F53;
            color: #ffffff;
            text-decoration: none;
            font-size: 22px;
            margin-left: 15px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .icons a:hover {
            background-color: #ffffff;
            color: #4E5F53;
        }
        .icons a.notification::after {
            content: "1";
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            width: 20px;
            height: 20px;
            font-size: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            display: none;
        }
        .text-s {
            font-size: 40px;
            font-weight: 400;
            color: #4E5F53;
            padding-bottom: 10px;
            border-bottom: solid 3px #4E5F53;
            margin: 0;
        }
        @media (max-width: 576px) {
            .text-s {
                font-size: 24px;
            }
        }
        .progress-container {
            position: relative;
            margin: 2rem 0;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .progress-bar {
            position: absolute;
            top: 16px;
            left: 0;
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            margin: 0;
            z-index: 0;
        }
        .progress-bar-fill {
            height: 100%;
            background: #4E5F53;
            transition: width 0.5s ease;
        }
        .progress-steps {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: space-between;
            z-index: 1;
        }
        .step-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }
        .progress-container span {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #e9ecef;
            color: #495057;
            font-size: 0.875rem;
            font-weight: 600;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease, color 0.3s ease;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            z-index: 2;
        }
        .progress-container span.active {
            background: #4E5F53;
            color: #fff;
            border-color: #4E5F53;
        }
        .step-counter {
            text-align: center;
            font-size: 0.875rem;
            color: #4E5F53;
            font-weight: 600;
            margin: 1.5rem 0;
            padding: 0.5rem;
            background: rgba(78, 95, 83, 0.1);
            border-radius: 6px;
            display: inline-block;
        }
        .question-card {
            border: solid 2px #4E5F53;
            border-radius: 10px;
            background: white;
            padding: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .question-card h3, .question-card h4 {
            color: #4E5F53;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: right;
        }
        .question-card p {
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 1.5rem;
            text-align: right;
        }
        .question-card label {
            display: block;
            font-size: 1rem;
            color: #4E5F53;
            margin-bottom: 0.5rem;
            text-align: right;
        }
        .question-card input, .question-card select {
            width: 100%;
            max-width: 300px;
            margin: 0.75rem auto;
            font-size: 1rem;
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 0.75rem;
            transition: border-color 0.3s ease;
        }
        .question-card input:focus, .question-card select:focus {
            border-color: #4E5F53;
            box-shadow: 0 0 5px rgba(78, 95, 83, 0.2);
            outline: none;
        }
        .btn-primary {
            background-color: #4E5F53;
            border: solid 1px #4E5F53;
            font-size: 18px;
            color: #ffffff;
            font-weight: 400;
            border-radius: 8px;
            padding: 10px 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0.5rem;
            min-width: 120px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary:hover {
            background-color: #ffffff;
            color: #4E5F53;
            border: solid 1px #4E5F53;
        }
        .btn-secondary {
            background-color: #6c757d;
            border: solid 1px #6c757d;
            font-size: 18px;
            color: #ffffff;
            font-weight: 400;
            border-radius: 8px;
            padding: 10px 20px;
            transition: background-color 0.3s ease, color 0.3s ease;
            margin: 0.5rem;
            min-width: 120px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-secondary:hover {
            background-color: #ffffff;
            color: #6c757d;
            border: solid 1px #6c757d;
        }
        .result-card {
            border: solid 2px #4E5F53;
            border-radius: 10px;
            background: white;
            padding: 2rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .result-card h4 {
            color: #4E5F53;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-align: right;
        }
        .result-card table {
            width: 100%;
            margin-bottom: 1.5rem;
            border-collapse: separate;
            border-spacing: 0;
        }
        .result-card table th, .result-card table td {
            padding: 1rem;
            border: 1px solid #dee2e6;
            text-align: right;
        }
        .result-card table th {
            background-color: rgba(78, 95, 83, 0.1);
            font-weight: 600;
            color: #4E5F53;
        }
        .result-card table td {
            background-color: #fff;
        }
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(78, 95, 83, 0.1);
            border-left-color: #4E5F53;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 1.5rem auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-spinner.active {
            display: inline-block;
        }
        #billRange {
            background: rgba(78, 95, 83, 0.1);
            padding: 1rem;
            border-radius: 8px;
            text-align: right;
            margin: 1.5rem 0;
            font-weight: 600;
            color: #4E5F53;
        }
        #message {
            padding: 1rem;
            border-radius: 8px;
            text-align: right;
            margin: 1rem 0;
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
        }
        .image-upload {
            margin-top: 1rem;
            text-align: center;
        }
        .image-upload label {
            display: block;
            font-size: 0.875rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        .image-upload input[type="file"] {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
            padding: 0.5rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            font-size: 1rem;
        }
        .image-upload input[type="file"]:focus {
            border-color: #4E5F53;
            box-shadow: 0 0 5px rgba(78, 95, 83, 0.2);
            outline: none;
        }
        .no-data-message {
            text-align: center;
            color: #dc3545;
            font-size: 1rem;
            margin-top: 1rem;
        }
        .model-details {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(78, 95, 83, 0.1);
            border-radius: 6px;
            font-size: 0.875rem;
            color: #4E5F53;
            text-align: right;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.25);
            padding: 1rem;
            border-radius: 4px;
            color: #dc3545;
            font-size: 0.875rem;
            text-align: right;
        }

        .error-message strong {
            display: block;
            margin-bottom: 0.5rem;
        }

        .error-message small {
            display: block;
            color: #842029;
            font-size: 0.8rem;
        }
        .model-details-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        @media (max-width: 768px) {
            .container {
                margin: 1rem auto;
                padding: 0 15px;
            }
            .btn-primary, .btn-secondary {
                font-size: 14px;
                padding: 8px 15px;
            }
            .question-card h3, .question-card h4 {
                font-size: 1.1rem;
            }
            .question-card p {
                font-size: 0.8rem;
            }
            .progress-container span {
                width: 24px;
                height: 24px;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="icons">
                <a href="#" class="notification"><i class="far fa-bell"></i></a>
            </div>
            <h2 class="text-s">إضافة جهاز</h2>
            <a href="season.html" class="back text-decoration-none"><i class="fa-solid fa-arrow-right"></i></a>
        </div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBarFill"></div>
            </div>
            <div class="progress-steps" id="progressBar"></div>
        </div>
        <div class="step-counter" id="stepCounter"></div>
        <div id="step-container"></div>

        <div class="text-center">
            <button id="yourDevicesButton" class="btn btn-primary" style="display:none">الأجهزة الخاص بك</button>
            <button id="detailedConsumptionButton" class="btn btn-primary" style="display:none">الجدول التفصيلي لاستهلاك الكهرباء</button>
            <div class="loading-spinner" id="loadingSpinner"></div>
        </div>

        <div id="result-section" style="display:none; margin-top: 20px;">
            <div class="result-card">
                <h4 class="text-right">الجدول الأول: بيانات الأجهزة</h4>
                <table class="table table-bordered text-right">
                    <thead><tr><th>الفئة</th><th>الطاقة الكهربائية</th><th>اسم الموديل</th></tr></thead>
                    <tbody id="rawPowerTable"></tbody>
                </table>
            </div>
            <div class="result-card">
                <h4 class="text-right">الجدول الثاني: الجدول التفصيلي لاستهلاك الكهرباء حسب نوع الجهاز</h4>
                <table class="table table-bordered text-right">
                    <thead><tr><th>الفئة</th><th>اسم الموديل</th><th>الاستهلاك الشهري (ك.و.س)</th><th>عدد ساعات التشغيل يوميًا</th></tr></thead>
                    <tbody id="summaryTable"></tbody>
                </table>
                <p id="billRange" class="mt-4 text-right font-weight-bold"></p>
                <p id="message" class="text-danger text-right"></p>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/electricity.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            if (!token) {
                const messageElement = document.getElementById('message');
                messageElement.innerText = 'يرجى تسجيل الدخول أولاً';
                setTimeout(() => {
                    window.location.href = 'Login.html';
                }, 5000);
                return;
            }
        });

        const devices = [
            { name: "الميزانية", models: [] },
            { name: "ثلاجة", models: ["FNT-B400 BB"] },
            { name: "غسالة", models: ["EL1087567SLV", "EL1094877SLV"] },
            { name: "مكيف", models: ["S4-H24TZAAE"] },
            { name: "غلاية كهربائية", models: ["EL1113367BLK"] },
            { name: "سخان مياه", models: ["TEEE-30MW"] },
            { name: "قلاية", models: ["TDF-3700"] },
            { name: "مكنسة كهربائية", models: ["TVC-1200B"] },
            { name: "غسالة أطباق", models: ["EL1108866SLV"] },
            { name: "بوتاجاز", models: ["HP41125B"] },
            { name: "مكواة بخار", models: ["GS42622A"] },
            { name: "فرن", models: ["ak-45"] },
            { name: "ميكروويف", models: ["MOM-C25BBE-BK"] },
            { name: "الأجهزة الخاص بك", models: [] },
            { name: "الجدول التفصيلي", models: [] }
        ];

        let currentStep = 0;
        let answers = [];
        let structuredAnswers = [];
        let budget = null;
        let apiData = null;

        const urlParams = new URLSearchParams(window.location.search);
        const season = urlParams.get('season') || 'summer';

        function renderProgressBar() {
            const totalSteps = 1 + (devices.length - 3) * 3;
            const visibleSteps = 15;
            const stepNumbers = Array.from({ length: visibleSteps }, (_, i) => i + 1);
            let visibleStep = 0;
            if (currentStep === 0) {
                visibleStep = 0;
            } else if (currentStep <= 36) {
                const deviceIndex = Math.min(Math.floor((currentStep - 1) / 3), devices.length - 3);
                visibleStep = deviceIndex + 1;
            } else if (currentStep === 37) {
                visibleStep = 13;
            } else {
                visibleStep = 14;
            }
            const progressPercentage = ((visibleStep + 1) / visibleSteps) * 100;
            document.getElementById("progressBarFill").style.width = `${progressPercentage}%`;
            document.getElementById("progressBar").innerHTML = stepNumbers.map((n, i) => `
                <div class="step-item">
                    <span class="${i === visibleStep ? 'active' : ''}">${n}</span>
                </div>
            `).join('');
            document.getElementById("stepCounter").innerText = `الخطوة ${visibleStep + 1} من ${visibleSteps}`;
        }

        async function sendToBackend(budget, structuredAnswers) {
            const loadingSpinner = document.getElementById("loadingSpinner");
            const messageElement = document.getElementById("message");
            
            loadingSpinner.classList.add("active");
            messageElement.innerText = '';

            const payload = [budget, ...structuredAnswers.flat()];
            console.log("📤 جاري إرسال البيانات إلى السيرفر... Payload:", payload);

            try {
                const data = await window.electricity.calculate(payload, season);
                console.log('✅ البيانات المستلمة من السيرفر:', data);

                // Format power values to include unit
                const formattedData = {
                    raw_power_data: data.rawPowerData?.map(row => ({
                        ...row,
                        "Electric Power": `${parseFloat(row["Electric Power"] || 0).toFixed(2)} واط`
                    })) || [],
                    summary: data.summary?.map(row => ({
                        ...row,
                        "Monthly Consumption (kWh)": `${parseFloat(row["Monthly Consumption (kWh)"] || 0).toFixed(2)} ك.و.س`
                    })) || [],
                    estimated_bill_range: data.estimatedBillRange || '',
                    message: data.message || ''
                };

                apiData = formattedData;
                console.log("📦 محتوى apiData بعد المعالجة:", apiData);

                // Update the tables immediately
                updateTables();
            } catch (error) {
                console.error('🚨 خطأ أثناء إرسال البيانات إلى السيرفر:', error);
                apiData = {
                    raw_power_data: [],
                    summary: [],
                    estimated_bill_range: "",
                    message: "فشل في جلب البيانات من السيرفر"
                };
                messageElement.innerText = `حدث خطأ: ${error.message}. يرجى المحاولة مرة أخرى لاحقًا.`;
            } finally {
                loadingSpinner.classList.remove("active");
            }
        }

        document.getElementById("yourDevicesButton").addEventListener("click", () => {
            if (!apiData) {
                document.getElementById("message").innerText = "يرجى الانتظار حتى يتم جلب البيانات";
                return;
            }

            const resultSection = document.getElementById("result-section");
            resultSection.style.display = "block";

            const rawPowerTable = document.getElementById("rawPowerTable");
            if (!rawPowerTable) {
                console.error("العنصر rawPowerTable غير موجود في الـ DOM");
                return;
            }

            if (apiData.raw_power_data && apiData.raw_power_data.length > 0) {
                rawPowerTable.innerHTML = apiData.raw_power_data.map(row =>
                    `<tr><td>${row.Category || 'غير محدد'}</td><td>${row["Electric Power"] || 'غير معروف'}</td><td>${row["Model Name"] || 'غير معروف'}</td></tr>`
                ).join('');
            } else {
                rawPowerTable.innerHTML = `<tr><td colspan="3" class="no-data-message">لا توجد بيانات متاحة للعرض</td></tr>`;
            }

            document.getElementById("yourDevicesButton").style.display = "none";
            currentStep++;
            renderStep();
        });

        function updateTables() {
            const resultSection = document.getElementById("result-section");
            resultSection.style.display = "block";

            // Update raw power table
            const rawPowerTable = document.getElementById("rawPowerTable");
            if (apiData.raw_power_data && apiData.raw_power_data.length > 0) {
                rawPowerTable.innerHTML = apiData.raw_power_data.map(row =>
                    `<tr>
                        <td>${row.Category || 'غير محدد'}</td>
                        <td>${row["Electric Power"] || 'غير معروف'}</td>
                        <td>${row["Model Name"] || 'غير معروف'}</td>
                    </tr>`
                ).join('');
            } else {
                rawPowerTable.innerHTML = `<tr><td colspan="3" class="no-data-message">لا توجد بيانات متاحة للعرض</td></tr>`;
            }

            // Update summary table
            const summaryTable = document.getElementById("summaryTable");
            if (apiData.summary && apiData.summary.length > 0) {
                summaryTable.innerHTML = apiData.summary.map(row =>
                    `<tr>
                        <td>${row.Category || 'غير محدد'}</td>
                        <td>${row["Model Name"] || 'غير معروف'}</td>
                        <td>${row["Monthly Consumption (kWh)"] || 'غير معروف'}</td>
                        <td>${row["Daily Hours"] || 'غير معروف'}</td>
                    </tr>`
                ).join('');
            } else {
                summaryTable.innerHTML = `<tr><td colspan="4" class="no-data-message">لا توجد بيانات متاحة للعرض</td></tr>`;
            }

            // Update bill range and message
            document.getElementById("billRange").innerText = apiData.estimated_bill_range ? `النطاق التقديري للفاتورة: ${apiData.estimated_bill_range} جنيه` : '';
            document.getElementById("message").innerText = apiData.message || '';
        }

        function renderStep() {
            const container = document.getElementById("step-container");
            container.innerHTML = "";
            document.getElementById("yourDevicesButton").style.display = "none";
            document.getElementById("detailedConsumptionButton").style.display = "none";
            renderProgressBar();

            const card = document.createElement("div");
            card.classList.add("question-card");

            if (currentStep === 0) {
                card.innerHTML = `
                    <label for="budget">ما هو الحد الأقصى للميزانية الشهرية؟</label>
                    <p class="text-muted">أدخل المبلغ الشهري الذي ترغب في إنفاقه</p>
                    <input type="number" id="budget" class="form-control" min="100" placeholder="أدخل الميزانية (جنيه)">
                    <button class="btn btn-primary mt-3" onclick="saveBudget()">التالي</button>`;
            } else if (currentStep < 1 + (devices.length - 3) * 3) {
                const deviceIndex = Math.min(Math.floor((currentStep - 1) / 3), devices.length - 3);
                const device = devices[deviceIndex + 1];
                if ((currentStep - 1) % 3 === 0) {
                    card.innerHTML = `
                        <h3>هل لديك ${device.name}؟</h3>
                        <p class="text-muted">حدد ما إذا كان لديك هذا الجهاز</p>
                        <button class="btn btn-primary" onclick="handleYes()">نعم</button>
                        <button class="btn btn-primary" onclick="handleNo()">لا</button>`;
                } else if ((currentStep - 1) % 3 === 1) {
                    card.innerHTML = `
                        <label for="deviceCount">كم عدد ${device.name} لديك؟</label>
                        <p class="text-muted">أدخل عدد الأجهزة الموجودة</p>
                        <input type="number" id="deviceCount" class="form-control" min="1" placeholder="أدخل العدد">
                        <button class="btn btn-primary mt-3" onclick="nextStep()">التالي</button>`;
                } else {
                    const count = answers[answers.length - 1];
                    card.innerHTML = `
                        <h4>اختر الموديلات (${device.name})</h4>
                        <p class="text-muted">اكتب اسم الموديل أو اختر من الاقتراحات</p>
                        ${Array.from({ length: count }, (_, i) => `
                            <div class="model-details-container">
                                <div style="flex: 1;">
                                    <input type="text" id="model_${i}" list="model_list_${i}" class="form-control my-2 model-input" placeholder="اكتب أو اختر الموديل">
                                    <datalist id="model_list_${i}">
                                        ${device.models.map(model => `<option value="${model}">${model}</option>`).join('')}
                                    </datalist>
                                </div>
                                <div class="model-details" id="modelDetails_${i}" style="display: none; flex: 1;"></div>
                            </div>
                            <div class="image-upload">
                                <label for="model_image_${i}">إذا كنت لا تعلم نوع الجهاز، يمكنك رفع صورة للتعرف عليه</label>
                                <input type="file" id="model_image_${i}" accept="image/*" title="ارفع صورة للتعرف على الجهاز">
                            </div>`).join('')}
                        <button class="btn btn-primary mt-3" onclick="submitModels(${count})">التالي</button>`;
                }
            } else if (currentStep >= 37) {
                document.getElementById("yourDevicesButton").style.display = "inline-block";
                document.getElementById("detailedConsumptionButton").style.display = "inline-block";
                card.innerHTML = `<p class="text-center">تم جمع بيانات الأجهزة بنجاح، يمكنك الآن عرض النتائج.</p>`;
            }
            container.appendChild(card);

            if ((currentStep - 1) % 3 === 2 && currentStep < 37) {
                const count = answers[answers.length - 1];
                setTimeout(() => {
                    for (let i = 0; i < count; i++) {
                        const modelInput = document.getElementById(`model_${i}`);
                        const modelDetails = document.getElementById(`modelDetails_${i}`);
                        if (modelInput && modelDetails) {
                            modelInput.addEventListener('change', () => {
                                const modelName = modelInput.value.trim();
                                if (modelName) {
                                    getModelDetails(modelName, modelDetails);
                                } else {
                                    modelDetails.style.display = 'none';
                                }
                            });
                        }
                    }
                }, 0);
            }
        }

        async function getModelDetails(modelName, detailsElement) {
            const messageElement = document.getElementById("message");
            messageElement.innerText = "";
            detailsElement.innerHTML = '<div class="loading-spinner active"></div>';

            try {
                const data = await window.electricity.getModelDetails(encodeURIComponent(modelName));
                console.log('بيانات الاستجابة:', data);

                if (data.success && data.modelDetails) {
                    const detailsStr = data.modelDetails;
                    // Split the details string into lines and create an object
                    const details = {};
                    detailsStr.split('\n').forEach(line => {
                        if (line.includes(':')) {
                            const [key, value] = line.split(':').map(s => s.trim());
                            details[key] = value;
                        }
                    });
                    
                    // Clean up and convert power value
                    let power = details["Electric Power"];
                    if (power) {
                        // Remove any whitespace and normalize decimal separator
                        power = power.replace(/\s+/g, '').replace(',', '.');
                        
                        // Check if it's in kW format
                        if (power.includes('kW')) {
                            power = parseFloat(power) * 1000 + ' واط';
                        } else if (power.includes('W')) {
                            // Remove the 'W' and keep the number
                            power = parseFloat(power) + ' واط';
                        } else {
                            // If no unit is specified, assume kW
                            power = parseFloat(power) * 1000 + ' واط';
                        }
                        
                        // Round to 2 decimal places if needed
                        const powerNum = parseFloat(power);
                        if (!isNaN(powerNum)) {
                            power = powerNum.toFixed(2) + ' واط';
                        }
                    }

                    detailsElement.innerHTML = `
                        <strong>اسم الموديل:</strong> ${details["Model Name"] || 'غير معروف'}<br>
                        <strong>العلامة التجارية:</strong> ${details.Brand || 'غير معروف'}<br>
                        <strong>الفئة:</strong> ${details["catogory"] || 'غير معروف'}<br>
                        <strong>الطاقة الكهربائية:</strong> ${power || 'غير معروف'}<br>
                        ${details.Capacity ? `<strong>السعة:</strong> ${details.Capacity} لتر` : ''}
                    `;
                    detailsElement.style.display = 'block';
                } else {
                    const errorMessage = data.error || 'لا توجد تفاصيل متوفرة لهذا الموديل';
                    detailsElement.innerHTML = `
                        <div class="error-message">
                            <strong>خطأ:</strong> ${errorMessage}<br>
                            <small>يمكنك إضافة هذا الموديل، لكن سيتم استخدام قيم افتراضية لحساب استهلاك الطاقة.</small>
                        </div>
                    `;
                    detailsElement.style.display = 'block';
                }
            } catch (error) {
                console.error('خطأ في جلب تفاصيل الموديل:', error);
                detailsElement.innerHTML = `
                    <div class="error-message">
                        <strong>خطأ:</strong> ${error.message}<br>
                        <small>يمكنك إضافة هذا الموديل، لكن سيتم استخدام قيم افتراضية لحساب استهلاك الطاقة.</small>
                    </div>
                `;
                detailsElement.style.display = 'block';
                messageElement.innerText = `خطأ: ${error.message}`;
            }
        }

        function saveBudget() {
            const input = document.getElementById("budget").value;
            if (!input || input < 100) {
                document.getElementById("message").innerText = "يرجى إدخال ميزانية صالحة (100 جنيه أو أكثر)";
                return;
            }
            budget = input.toString();
            currentStep++;
            renderStep();
        }

        function handleYes() {
            answers.push("yes");
            structuredAnswers.push(["yes"]);
            currentStep++;
            renderStep();
        }

        function handleNo() {
            answers.push("no");
            structuredAnswers.push(["no", "0"]);
            currentStep = Math.min(currentStep + 3, 1 + (devices.length - 3) * 3);
            renderStep();
        }

        function nextStep() {
            const count = parseInt(document.getElementById("deviceCount").value);
            if (!count || count < 1) {
                document.getElementById("message").innerText = "يرجى إدخال عدد صحيح";
                return;
            }
            answers.push(count.toString());
            structuredAnswers[structuredAnswers.length - 1].push(count.toString());
            currentStep++;
            renderStep();
        }

        async function submitModels(count) {
            const messageElement = document.getElementById("message");
            messageElement.innerText = "";

            for (let i = 0; i < count; i++) {
                const model = document.getElementById(`model_${i}`).value.trim();
                if (!model) {
                    messageElement.innerText = `يرجى كتابة أو اختيار موديل للجهاز رقم ${i + 1}`;
                    return;
                }
                answers.push(model);
                structuredAnswers[structuredAnswers.length - 1].push(model);

                const imageInput = document.getElementById(`model_image_${i}`);
                if (imageInput.files.length > 0) {
                    try {
                        const formData = new FormData();
                        formData.append('image', imageInput.files[0]);
                        await window.api.post('/Electricity/upload-image', formData);
                        console.log(`تم رفع صورة للجهاز ${i + 1}:`, imageInput.files[0].name);
                    } catch (error) {
                        console.error('خطأ في رفع الصورة:', error);
                        messageElement.innerText = `خطأ في رفع صورة الجهاز ${i + 1}: ${error.message}`;
                        return;
                    }
                }
            }
            currentStep++;
            if (currentStep === 37) {
                await sendToBackend(budget, structuredAnswers);
            }
            renderStep();
        }

        document.getElementById("detailedConsumptionButton").addEventListener("click", () => {
            if (!apiData) {
                document.getElementById("message").innerText = "يرجى عرض الأجهزة الخاص بك أولاً";
                return;
            }

            const summaryTable = document.getElementById("summaryTable");
            if (!summaryTable) {
                console.error("العنصر summaryTable غير موجود في الـ DOM");
                return;
            }

            if (apiData.summary && apiData.summary.length > 0) {
                summaryTable.innerHTML = apiData.summary.map(row => `
                    <tr>
                        <td>${row.Category || 'غير محدد'}</td>
                        <td>${row["Model name"] || 'غير معروف'}</td>
                        <td>${row["Monthly Consumption (kWh)"] || 'غير معروف'}</td>
                        <td>${row["Daily Hours"] || 'غير معروف'}</td>
                    </tr>
                `).join('');
                document.getElementById("billRange").innerText = apiData.estimated_bill_range ? `النطاق التقديري للفاتورة: ${apiData.estimated_bill_range} جنيه` : '';
                document.getElementById("message").innerText = apiData.message || '';
            } else {
                summaryTable.innerHTML = `<tr><td colspan="4" class="no-data-message">لا توجد بيانات استهلاك متاحة حاليًا</td></tr>`;
                document.getElementById("billRange").innerText = apiData.estimated_bill_range ? `النطاق التقديري للفاتورة: ${apiData.estimated_bill_range} جنيه` : '';
                document.getElementById("message").innerText = apiData.message || '';
            }
            document.getElementById("detailedConsumptionButton").style.display = "none";
        });

        document.addEventListener('DOMContentLoaded', function() {
            renderStep();
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'Login.html';
        }
    </script>
</body>
</html>